<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <!-- crayons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/css/crayons-min.css" />
    <!-- Toastify -->
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
    <!-- external css -->
     <!-- <link rel="stylesheet" href="./assets/iparams.css" /> -->
    <script src="{{{appclient}}}"></script>
    <style>
        body{
            font-family:Open Sans,Helvetica Neue,sans-serif;
        }

        #show-signup-page{
            cursor: pointer;
            color:blue;
        }

        #login-btn-container, #signup-btn-container, #service-validation-btn-container{
            display: flex;
            justify-content: center;
        }

        #signup-page{
            display: none;
        }  
        
        .font{
            font-family:Open Sans,Helvetica Neue,sans-serif;
        }

        #signup-btn{
            margin-left: 10px;
        }

        .password-icon{
            margin-left: 15px;
            cursor: pointer;
        }

    </style>
</head>

<body>
    <!-- toast -->
    <fw-toast id="toast-msg"></fw-toast>

    <!-- signup tab -->
    <div id="signup-page">
        <fw-tabs>
         <fw-tab slot="tab" panel="signup">Signup</fw-tab>
         <fw-tab-pannel name="signup">
            <br>
            <!-- username field -->
            <fw-input label="Username" icon-left="at-the-rate" hint-text="Create your konnector's ipaas username"
            warning-text="Username field should not be empty" 
            placeholder="eg: Mark1123" required clear-input id="signup-username">
             </fw-input>
            <br>
            <!-- email field -->
            <fw-input label="Email" icon-left="email" hint-text="Create your konnector's ipaas email"
            warning-text="email field should not be empty" error-text="Invalid email address" type="email"
            placeholder="eg: someone@example.com" required clear-input id="signup-email">
             </fw-input>
            <br>
            <!-- password field -->
            <fw-input label="Password" icon-left="password" hint-text="Create your konnector's ipaas password"
            warning-text="Password field should not be empty" type="password" 
            placeholder="eg: pass@w58ord" required clear-input id="signup-password">
             <fw-icon name="hidden" slot="input-suffix" id="signup-password-icon" class="password-icon"></fw-icon>
             </fw-input>
            <br>
            <!-- company name field -->
            <fw-input label="Company" icon-left="company" hint-text="Please enter your company name"
            warning-text="Company name field should not be empty"  
            placeholder="eg: konnectify" required clear-input id="signup-company">
             </fw-input>
            <br>
            <!-- phone number field -->
            <fw-input label="Phone" icon-left="phone" hint-text="Please enter your contact number with country code"
            warning-text="phone number field should not be empty" type="text" minlength="10" maxlength="10"
            placeholder="eg:+91 8975xxx579" required clear-input id="signup-phone">
             </fw-input>
            <br>
            <div id="signup-btn-container">
                <fw-button id="back-btn" color="secondary">
                    <!-- back button -->
                    <fw-icon name="arrow-left"></fw-icon>&nbsp; Back  
                 </fw-button>
                 <!-- signup button -->
                <fw-button id="signup-btn">Signup</fw-button>
            </div>
            <br>
         </fw-tab-pannel>
        </fw-tabs>
    </div>
    
       
    <!-- settings page tab -->
    <div id="settings-page">
        <fw-tabs id="settings-tab">
            <fw-tab slot="tab" panel="login">Login</fw-tab>
            <fw-tab slot="tab" panel="freshservice" disabled="true" id="freshservice-tab">Freshservice</fw-tab>
  
            <fw-tab-panel name="login">
              <!-- login credentials -->
              <div id="login-container"> <br>
                <!-- email field -->
                <div id="input-container">
                    <fw-input label="Email" icon-left="at-the-rate" hint-text="Please enter your konnector's ipaas email"
                    warning-text="Email field should not be empty" type="email"
                    placeholder="eg: someone@example.com" required clear-input id="login-email">
                </fw-input>
            </div>
            <br>
            <!-- password field -->
            <div id="password-container">
                <fw-input label="Password" icon-left="password" hint-text="Please enter your konnector's ipaas password"
                warning-text="Password field should not be empty"  type="password" 
                placeholder="eg: pass@w58ord" required clear-input id="login-password">
                    <fw-icon name="hidden" slot="input-suffix" id="login-password-icon" class="password-icon"></fw-icon>
            </fw-input> 
        </div>
        <br>
        <!-- validate button -->
        <div id="login-btn-container">
            <fw-button color="primary" id="login-btn"> Login </fw-button>
        </div>
        <br>
        
        <div style="font-family:Open Sans,Helvetica Neue,sans-serif">
            <!-- <fw-button modal-trigger-id='modal-slider' id=""> Click here </fw-button> -->
            <span>Don't you have an account ? </span>
            <span id="show-signup-page">Click here!</span>
        </div>
        <br>
        </div>
            </fw-tab-panel>
  
            <fw-tab-panel name="freshservice">
                <div id="service-validation">

                </div>

                <div id="service-validation-btn-container">
                    <fw-button id="service-validate-btn">validate</fw-button>
                </div>
            </fw-tab-panel>
        </fw-tabs>
    </div>
    
<script>
        // varibales declaration
        let is_login_successful = false;
        let service_field_container = document.getElementById("service-validation"); // the product we are integrating 
        const service_provider = "freshservice.com";
        const login_email = document.getElementById("login-email");
        const login_password = document.getElementById("login-password");
        const login_btn = document.getElementById("login-btn");
        const signup_company = document.getElementById("signup-company");
        const signup_phone = document.getElementById("signup-phone");
        const signup_btn = document.getElementById("signup-btn");
        const show_signup_page = document.getElementById("show-signup-page"); 
        const signup_username = document.getElementById("signup-username");
        const signup_password = document.getElementById("signup-password");
        const signup_email = document.getElementById("signup-email");
        const signup_page = document.getElementById("signup-page");
        const settings_page = document.getElementById("settings-page");
        const goto_signup = document.getElementById("show-signup-page");
        const go_back_btn = document.getElementById("back-btn");
        const toast = document.getElementById('toast-msg');
        const freshservice_tab = document.getElementById("freshservice-tab");
        const service_validation_btn = document.getElementById("service-validate-btn");
        const login_password_icon = document.getElementById("login-password-icon");      
        const signup_password_icon = document.getElementById("signup-password-icon");
        const settings_tab = document.getElementById("settings-tab");
        let access_token;
        let base_url = "";  

        document.addEventListener("DOMContentLoaded", function () {
            app
                .initialized()
                .then(function (_client) {
                    window.client = _client;
                    login_btn.addEventListener("click", () => login(isValidUser));
                    login_email.addEventListener("fwInput", () => login_email.state = "normal");
                    login_password.addEventListener("fwInput", () => login_password.state = "normal");
                    signup_phone.addEventListener("fwInput", () => {
                        signup_phone.errorText = "";
                        signup_phone.state = "normal";
                    });
                    signup_username.addEventListener("fwInput", () =>  signup_username.state = "normal");
                    signup_password.addEventListener("fwInput", () =>  signup_password.state = "normal");
                    signup_company.addEventListener("fwInput", () =>  signup_company.state = "normal");
                    signup_phone.addEventListener("fwInput", () =>  signup_phone.state = "normal");
                    signup_email.addEventListener("fwInput", () =>  signup_email.state = "normal");
                    signup_btn.addEventListener("click", signup);
                    goto_signup.addEventListener("click", () => togglePage(true));
                    go_back_btn.addEventListener("click", () => togglePage(false));
                    service_validation_btn.addEventListener("click" , validateServiceCredentials);
                    login_password_icon.addEventListener("click", () => tooglePasswordVisiblity(login_password, login_password_icon));
                    signup_password_icon.addEventListener("click", () => tooglePasswordVisiblity(signup_password, signup_password_icon));
                })
                .catch(function (err) {
                    console.error("error in app initialization", err);
                });
        });

        function tooglePasswordVisiblity(inputElement, icon){
            const input_type = inputElement.type;
            console.log("input type", input_type);
            if(input_type === "password"){
                inputElement.type = "text";
                icon.name = "visible";
            } else {
                inputElement.type = "password";
                icon.name = "hidden";
            }
        }

        // to toggle between login and signup page
        function togglePage(showLogin){
            console.log("show login page", showLogin)
            settings_page.style.display = showLogin ? "none" : "block";
            signup_page.style.display = showLogin ? "block" : "none";
        }


        function postConfigs(){
            const login_email = login_email.value.trim();
            const login_password = login_password.value.trim();
            return {
                email:login_email,
                password:login_password,
                base_url,
                access_token // access_token variable gets value once the user is signed up or logged in successfully
            }
        }

        function getConfigs(iparams){
            login_email.value = iparams.login_email;
            login_password.value = iparams.login_password;
        }

        // to validate login credentials
        function login(){
            // todo: instead of cb set a flag to verify
            console.log('validation fired',login_email, login_email.value)
            // if email field is empty
            if(!login_email.value){
                login_email.state = "warning";
                // callback(false)
                return 
            } 
            // if password field is empty
            if(!login_password.value){
                login_password.state = "warning";
                //  callback(false)
                return
            }
            login_btn.loading = true;
            console.log("host",login_email.value.trim().includes(service_provider) ? login_email.value.trim() : login_email.value.trim() + "." + service_provider)
            client.request.invokeTemplate(
                "login",
                {
                    context: {
                        // todo: add base url
                        base_url: base_url,
                    },
                    body: JSON.stringify({
                        email: trimTheString(login_email),
                        password: trimTheString(login_password)
                    })
                })
                .then((response) => {
                    if(response && response.user){
                        login_btn.disabled = true;
                        // callback(true);
                        console.log('response from api', response);
                        toast.trigger({type:'success', content: "Login Successful"});
                        login_btn.loading = false;
                        freshservice_tab.disabled = false;
                        service_field_container.innerHTML = '';
                        generateFields(); // todo: get app schema + dynamic field creation
                        settings_tab.activeTabIndex = 1; // switching to next tab
                    }
                })
                .catch((error) => {
                    toast.trigger({type:'error', content: "Invalid Credentials"}) 
                    console.error("api error", error);
                    login_btn.loading = false;
                    login_btn.disabled = false;
                    // callback(false);
                });
        }


        function validate(){
            return false
        }

        async function signup(){
            try {
            console.log('signup function called');
            const phone = trimTheString(signup_phone);
            const company = trimTheString(signup_company);
            const username = trimTheString(signup_username);
            const password = trimTheString(signup_password);
            const email = trimTheString(signup_email);
            const is_valid_email = isValidEmail(email);
            let is_valid = true;
            const signup_fields = [signup_username, signup_email, signup_password, signup_company, signup_phone];

            for(let i=0; i<signup_fields.length; i++){
                if(!signup_fields[i].value){
                    signup_fields[i].state = "warning";
                    signup_fields[i].setFocus();
                    is_valid = false;
                    return
                }
            }

            // validate email
            if(!is_valid_email){
                signup_email.state = "error";
                signup_email.setFocus();
                return
            }
        
            const payload = {
                username,
                email,
                password,
                phone,
                company
            }
            // proceed further if all the fields contains value 
            if(is_valid){
            const signup_request = await client.request.invokeTemplate("signup", {
                context:{
                    base_url: base_url
                },
                body: JSON.stringify(payload)
            });
            const signup_response = await signup_request;
            // look for token. If token is avilable then store the token in iparam
            if(signup_response.access_token){
                const user_email = signup_response.user.email;
                access_token = signup_response.access_token;
                // after successful registeration auto login the user
                login_email.value = email; 
                login_password.value = password;
                login_btn.click(); 
            } else {
                toast.trigger({type:'error', content: "Token is missing"});
                return
            }
            }
            } catch (error) {
               console.log('error in signup', error); 
               toast.trigger({type:'error', content: "sorry, signup failed!"});
            }

        }

        function isValidEmail(email){
            const regex = /^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,6}$/;
            return regex.test(email);
        }

        function trimTheString(element){
            return element?.value?.trim()
        }


        async function generateFields(){
        try {
            // get fields from get app schema
            const get_app_schema = await client.request.invokeTemplate("getAppSchema", {
                context: {
                    base_url: base_url
                }
            });
            const response = await get_app_schema;
            // todo: fields should be fetched from api
            const fields = response.fields;
            // {fieldName: fieldType}
            let fields_to_add = '';
            for(let i=0; i<fields.length; i++){
                const new_Element = createAppFields(fields[i]);
                // if no field is returned from createAppFields
                if(!new_Element){
                    toast.trigger({type:'error', content: "Error in creating app field"});
                    return
                }
                fields_to_add = fields_to_add + new_Element;
            }
            service_field_container.innerHTML = fields_to_add;
        } catch (error) {
            console.log("error in creating app fields", error);
            toast.trigger({type:'error', content: "Fetching app schema failed"});
        }  
        }

        function createAppFields(fieldData){
            let element = '';
            if(fieldData.type === "textbox" || fieldData.type === "textarea"){
                element = `<fw-input label="${fieldData.name}" hint-text="${fieldData.required.message}" warn-text="${fieldData.pattern.message}"
                required="${fieldData.required.value}" clear-input  placeholder="${fieldData.placeholder}" type="text" > 
                </fw-input>`;
                return element
            } else if(fieldData.type === "password"){
                element = `<fw-input label="${fieldData.name}" hint-text="${fieldData.required.message}" 
                required="${fieldData.required.value}" clear-input  type="password" > 
                </fw-input>`;
                return element
            } else {
                return element
            }
        }

        // to validate the service credentials
        function validateServiceCredentials(){
            // todo: api will be provided to check the app validation
            const fields = ["domain", "api-key"];
            console.log('service validation triggered')
        }

    </script>
    <!-- crayons -->
    <script type="module"
        src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.esm.js">
    </script>
    <script nomodule src="https://cdn.jsdelivr.net/npm/@freshworks/crayons@v4/dist/crayons/crayons.js"></script>
</body>

</html>